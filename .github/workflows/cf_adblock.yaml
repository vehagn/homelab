name: Monthly Cloudflare Adblock Update

on:
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: "0 0 1 * *" # Runs at 00:00 UTC on the 1st day of every month

env:
  TF_VAR_gcs_env: prod

permissions:
  contents: read
  id-token: write

jobs:
  update_cf_adblock:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/karteekiitg/k8s_setup:latest

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Load .env file to environment
        run: |
          if [ -f "./.env" ]; then
            echo "Sourcing .env file..."
            grep -v '^[[:space:]]*#' ./.env | grep -v '^[[:space:]]*$' | grep '=' >> $GITHUB_ENV
            echo "Finished processing .env file for GITHUB_ENV."
          else
            echo -e "\033[31mError: .env file not found at ./.\033[0m"
            exit 1
          fi

      - name: Load secrets to environment
        env: # Environment variables specific to THIS step
          TF_VAR_infisical_client_secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
        run: |
          echo "Making setup_infisical.sh executable..."
          chmod +x ./.devcontainer/setup_infisical.sh
          echo "Running setup_infisical.sh..."
          ./.devcontainer/setup_infisical.sh
          if [ $? -ne 0 ]; then
            echo -e "\033[31mError: setup_infisical.sh failed. See script output above for details.\033[0m"
            exit 1
          fi

          EXPORT_FILE="$HOME/.infisical_exports.env"

          if [ -f "$EXPORT_FILE" ]; then
            echo "Sourcing secrets from $EXPORT_FILE to GITHUB_ENV (filtering, handling 'export' prefix, and stripping quotes)..."

            # Pre-filter with grep to remove comments and truly empty lines, ensure '=' exists
            # Then pipe into the while loop for further processing
            grep -v '^[[:space:]]*#' "$EXPORT_FILE" | grep -v '^[[:space:]]*$' | grep '=' | \
            while IFS= read -r line || [ -n "$line" ]; do # Read whole line
              # Remove "export " prefix if it exists from the already filtered line
              line_no_export="${line#export }"

              # At this point, 'line_no_export' should be in KEY=VALUE format
              # (possibly with quotes around VALUE) because of the preceding grep filters.
              # We still split to handle the value quoting.

              key="${line_no_export%%=*}"
              value_with_potential_quotes="${line_no_export#*=}"

              # Remove leading/trailing single quotes from value_with_potential_quotes
              value_cleaned="${value_with_potential_quotes#\'}"
              value_cleaned="${value_cleaned%\'}"
              # Remove leading/trailing double quotes from value_with_potential_quotes
              value_cleaned="${value_cleaned#\"}"
              value_cleaned="${value_cleaned%\"}"

              echo "$key=$value_cleaned" >> $GITHUB_ENV
            done

            echo "Finished processing $EXPORT_FILE for GITHUB_ENV."
            echo "Removing $EXPORT_FILE..."
            rm -f "$EXPORT_FILE"
          else
            echo -e "\033[31mError: Secrets export file ($EXPORT_FILE) was not found after running setup_infisical.sh.\033[0m"
            exit 1
          fi
          echo "Secrets loaded and temporary file removed."

      - name: Authenticate to Google Cloud
        id: google-auth
        uses: google-github-actions/auth@ba79af03959ebeac9769e648f473a284504d9193
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }} # Now from Infisical via env
          service_account: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL }} # Now from Infisical via env

      - name: Run Adblock List Chunking Script
        run: bash chunk_adblock_lists.sh 1000
        working-directory: ./tofu/cf-adblock # Ensures script is run in the correct context

      - name: OpenTofu Init for cf-adblock
        run: tofu init
        working-directory: ./tofu/cf-adblock

      - name: OpenTofu Plan for cf-adblock
        id: plan # This ID is used by GHA to set steps.plan.outputs.exitcode
        shell: bash
        run: |
          set -o pipefail # Ensures that if tofu plan fails, the script fails
          tofu plan -out=tfplan -detailed-exitcode
          PLAN_EXIT_CODE=$? # Capture the exit code of tofu plan

          echo "tofu_plan_exit_code=${PLAN_EXIT_CODE}" >> $GITHUB_OUTPUT # Make it available as a step output

          if [ $PLAN_EXIT_CODE -eq 1 ]; then
            echo "OpenTofu plan encountered an error."
            exit 1 # Explicitly fail the step for GHA if plan had an error
          else
            echo "OpenTofu plan completed. Exit code: $PLAN_EXIT_CODE (0=no changes, 2=changes exist)"
            exit 0 # Explicitly mark step as success for GHA if 0 or 2
          fi
        working-directory: ./tofu/cf-adblock

      - name: OpenTofu Apply for cf-adblock
        id: apply
        # Only apply if the plan has changes (tofu_plan_exit_code '2')
        if: steps.plan.outputs.tofu_plan_exit_code == '2'
        shell: bash
        run: tofu apply -auto-approve tfplan
        working-directory: ./tofu/cf-adblock

      - name: Plan Summary
        shell: bash
        # This step should ideally run regardless of the apply step's outcome,
        # so 'if: always()' might be useful if previous steps could fail and you still want a summary.
        # For now, it runs if the plan step didn't hard fail (exit 1).
        run: |
          PLAN_DETAILED_EXIT_CODE="${{ steps.plan.outputs.tofu_plan_exit_code }}"
          GHA_PLAN_STEP_EXIT_CODE="${{ steps.plan.exitcode }}" # Original GHA exit code for the plan step

          echo "OpenTofu Plan Detailed Exit Code (from step output): $PLAN_DETAILED_EXIT_CODE"
          echo "GitHub Actions 'OpenTofu Plan' Step Exit Code: $GHA_PLAN_STEP_EXIT_CODE"

          if [ "$PLAN_DETAILED_EXIT_CODE" = "0" ]; then
            echo "OpenTofu Plan: No changes were found."
          elif [ "$PLAN_DETAILED_EXIT_CODE" = "2" ]; then
            # Check if the apply step actually ran and its outcome
            # This assumes you give the apply step an id: apply as shown above
            if [ "${{ steps.apply.outcome }}" == "success" ] && [ "${{ steps.apply.conclusion }}" == "success" ]; then
              echo "OpenTofu Plan: Changes were found and successfully applied."
            elif [ "${{ steps.apply.outcome }}" == "failure" ] || [ "${{ steps.apply.conclusion }}" == "failure" ]; then
              echo -e "\033[31mOpenTofu Plan: Changes were found, but the apply step failed.\033[0m"
            elif [ "${{ steps.plan.outputs.tofu_plan_exit_code }}" == "2" ]; then
              # This case means apply step was skipped because its 'if' condition wasn't met
              # (e.g. if apply was conditional on something else beyond plan exit code 2)
              # OR if the apply step doesn't have an id or outcome isn't being checked.
              # For your current setup, if plan is 2, apply *should* run.
              echo "OpenTofu Plan: Changes were found. Apply step was triggered."
            fi
          elif [ "$PLAN_DETAILED_EXIT_CODE" = "1" ]; then
            echo -e "\033[31mOpenTofu Plan: Plan generation failed with an error (Code: $PLAN_DETAILED_EXIT_CODE).\033[0m"
          else
            echo -e "\033[31mOpenTofu Plan: Encountered an unexpected detailed exit code: $PLAN_DETAILED_EXIT_CODE.\033[0m"
          fi
        working-directory: ./tofu/cf-adblock
